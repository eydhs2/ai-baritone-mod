name: 发布版本

on:
  push:
    tags:
      - 'v*'  # 当推送 v1.0.0, v2.1.3 等标签时触发
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: 1.0.0)'
        required: true

jobs:
  build-all:
    name: 构建全版本
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      
      - name: 构建所有版本
        run: |
          chmod +x gradlew
          mkdir -p release
          
          # 定义所有支持的版本
          VERSIONS=(
            "1.15.2" "1.16.5" "1.17.1" "1.18.2" "1.19.2" "1.19.4"
            "1.20.1" "1.20.4" "1.20.6" "1.21" "1.21.1" "1.21.3"
            "1.21.4" "1.21.5" "1.21.6" "1.21.7" "1.21.8"
          )
          
          for VERSION in "${VERSIONS[@]}"; do
            echo "========================================="
            echo "构建 Minecraft $VERSION"
            echo "========================================="
            
            # 更新 gradle.properties
            case "$VERSION" in
              1.15.2)
                YARN="1.15.2+build.14"; LOADER="0.14.22"; FABRIC="0.44.0+1.18"
                ;;
              1.21.8)
                YARN="1.21.8+build.2"; LOADER="0.16.9"; FABRIC="0.115.0+1.21.8"
                ;;
              # ... 其他版本配置（同 build.yml）
            esac
            
            sed -i "s/^minecraft_version=.*/minecraft_version=$VERSION/" gradle.properties
            sed -i "s/^yarn_mappings=.*/yarn_mappings=$YARN/" gradle.properties
            sed -i "s/^loader_version=.*/loader_version=$LOADER/" gradle.properties
            sed -i "s/^fabric_version=.*/fabric_version=$FABRIC/" gradle.properties
            
            ./gradlew clean build
            cp build/libs/ai-baritone-helper-*.jar "release/ai-baritone-$VERSION.jar"
          done
          
          # 生成校验和
          cd release
          sha256sum *.jar > checksums.txt
          md5sum *.jar >> checksums.txt
          
          # 生成发布说明
          echo "# AI Baritone Helper ${{ github.ref_name }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## 支持版本" >> RELEASE_NOTES.md
          for VERSION in "${VERSIONS[@]}"; do
            echo "- Minecraft $VERSION" >> RELEASE_NOTES.md
          done
          echo "" >> RELEASE_NOTES.md
          echo "## 8大AI模型支持" >> RELEASE_NOTES.md
          echo "- 通义千问、豆包、GLM、DeepSeek、OpenAI、Kimi、文心一言、Ollama" >> RELEASE_NOTES.md
      
      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: AI Baritone ${{ github.ref_name }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/*.jar
            release/checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
