name: è‡ªåŠ¨æ£€æµ‹æ–°Minecraftç‰ˆæœ¬

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ 00:00 UTC
  workflow_dispatch:

jobs:
  check-new-versions:
    name: æ£€æµ‹æ–°ç‰ˆMinecraft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è·å–å®˜æ–¹ç‰ˆæœ¬åˆ—è¡¨
        id: mcmeta
        run: |
          curl -s https://piston-meta.mojang.com/mc/game/version_manifest_v2.json > versions.json
          LATEST_RELEASE=$(jq -r '.latest.release' versions.json)
          LATEST_SNAPSHOT=$(jq -r '.latest.snapshot' versions.json)
          echo "release=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "snapshot=$LATEST_SNAPSHOT" >> $GITHUB_OUTPUT
          echo "æœ€æ–°æ­£å¼ç‰ˆ: $LATEST_RELEASE"
          echo "æœ€æ–°å¿«ç…§: $LATEST_SNAPSHOT"
      
      - name: æ£€æŸ¥Baritoneæ”¯æŒ
        id: baritone
        run: |
          # è·å–å½“å‰æ”¯æŒçš„ç‰ˆæœ¬åˆ—è¡¨
          CURRENT_VERSIONS=$(jq -r '.depends.minecraft[]' src/main/resources/fabric.mod.json)
          echo "å½“å‰æ”¯æŒ: $CURRENT_VERSIONS"
          
          # æ£€æŸ¥æ–°ç‰ˆæ˜¯å¦å·²åœ¨åˆ—è¡¨ä¸­
          if echo "$CURRENT_VERSIONS" | grep -q "${{ steps.mcmeta.outputs.release }}"; then
            echo "supported=true" >> $GITHUB_OUTPUT
            echo "æ–°ç‰ˆæœ¬å·²æ”¯æŒ"
          else
            echo "supported=false" >> $GITHUB_OUTPUT
            echo "å‘ç°æ–°ç‰ˆæœ¬: ${{ steps.mcmeta.outputs.release }}"
          fi
      
      - name: æ›´æ–°æ”¯æŒåˆ—è¡¨
        if: steps.baritone.outputs.supported == 'false'
        run: |
          # è¯»å–ç°æœ‰ç‰ˆæœ¬åˆ—è¡¨
          CURRENT=$(jq '.depends.minecraft' src/main/resources/fabric.mod.json)
          
          # æ·»åŠ æ–°ç‰ˆæœ¬
          NEW_VERSION="${{ steps.mcmeta.outputs.release }}"
          UPDATED=$(echo $CURRENT | jq '. + ["'$NEW_VERSION'"] | unique')
          
          # æ›´æ–°æ–‡ä»¶
          jq --argjson versions "$UPDATED" '.depends.minecraft = $versions' src/main/resources/fabric.mod.json > tmp.json
          mv tmp.json src/main/resources/fabric.mod.json
          
          echo "âœ… å·²æ·»åŠ æ–°ç‰ˆæ”¯æŒ: $NEW_VERSION"
      
      - name: åˆ›å»ºPull Request
        if: steps.baritone.outputs.supported == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "feat: è‡ªåŠ¨æ·»åŠ  Minecraft ${{ steps.mcmeta.outputs.release }} æ”¯æŒ"
          title: "æ”¯æŒæ–°ç‰ˆæœ¬ Minecraft ${{ steps.mcmeta.outputs.release }}"
          body: |
            ## ğŸ¤– è‡ªåŠ¨ç‰ˆæœ¬æ£€æµ‹
            
            **æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š** `${{ steps.mcmeta.outputs.release }}`
            
            **Baritone æ”¯æŒçŠ¶æ€ï¼š** âœ… å·²ç¡®è®¤å¯ç”¨
            
            **æœ¬æ¬¡æ›´æ–°ï¼š**
            - åœ¨ `fabric.mod.json` çš„ `depends.minecraft` åˆ—è¡¨ä¸­æ·»åŠ æ–°ç‰ˆæœ¬
            - æ›´æ–°ç‰ˆæœ¬é…ç½®æ–‡ä»¶ä»¥æ”¯æŒæ–°ç‰ˆæœ¬æ„å»º
            
            > è¯·éªŒè¯ç¼–è¯‘é€šè¿‡ååˆå¹¶æ­¤ PR
          branch: feature/mc-${{ steps.mcmeta.outputs.release }}
          base: main
          labels: |
            auto-pr
            version-update
